<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Vertical Blanking</title><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"><link rel="home" href="index.html" title="Linux DRM Developer's Guide"><link rel="up" href="drmInternals.html" title="Chapter 2. DRM Internals"><link rel="prev" href="drm-kms-properties.html" title="KMS Properties"><link rel="next" href="API-drm-vblank-cleanup.html" title="drm_vblank_cleanup"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Vertical Blanking</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="drm-kms-properties.html">Prev</a> </td><th width="60%" align="center">Chapter 2. DRM Internals</th><td width="20%" align="right"> <a accesskey="n" href="API-drm-vblank-cleanup.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="drm-vertical-blank"></a>Vertical Blanking</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="drm-vertical-blank.html#idm14950">Vertical Blanking and Interrupt Handling Functions Reference</a></span></dt></dl></div><p>
      Vertical blanking plays a major role in graphics rendering. To achieve
      tear-free display, users must synchronize page flips and/or rendering to
      vertical blanking. The DRM API offers ioctls to perform page flips
      synchronized to vertical blanking and wait for vertical blanking.
    </p><p>
      The DRM core handles most of the vertical blanking management logic, which
      involves filtering out spurious interrupts, keeping race-free blanking
      counters, coping with counter wrap-around and resets and keeping use
      counts. It relies on the driver to generate vertical blanking interrupts
      and optionally provide a hardware vertical blanking counter. Drivers must
      implement the following operations.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><pre class="synopsis">int (*enable_vblank) (struct drm_device *dev, int crtc);
void (*disable_vblank) (struct drm_device *dev, int crtc);</pre><p>
	  Enable or disable vertical blanking interrupts for the given CRTC.
	</p></li><li class="listitem"><pre class="synopsis">u32 (*get_vblank_counter) (struct drm_device *dev, int crtc);</pre><p>
	  Retrieve the value of the vertical blanking counter for the given
	  CRTC. If the hardware maintains a vertical blanking counter its value
	  should be returned. Otherwise drivers can use the
	  <code class="function">drm_vblank_count</code> helper function to handle this
	  operation.
	</p></li></ul></div><p>
      Drivers must initialize the vertical blanking handling core with a call to
      <code class="function">drm_vblank_init</code> in their
      <code class="methodname">load</code> operation. The function will set the struct
      <span class="structname">drm_device</span>
      <em class="structfield"><code>vblank_disable_allowed</code></em> field to 0. This will
      keep vertical blanking interrupts enabled permanently until the first mode
      set operation, where <em class="structfield"><code>vblank_disable_allowed</code></em> is
      set to 1. The reason behind this is not clear. Drivers can set the field
      to 1 after <code class="function">calling drm_vblank_init</code> to make vertical
      blanking interrupts dynamically managed from the beginning.
    </p><p>
      Vertical blanking interrupts can be enabled by the DRM core or by drivers
      themselves (for instance to handle page flipping operations). The DRM core
      maintains a vertical blanking use count to ensure that the interrupts are
      not disabled while a user still needs them. To increment the use count,
      drivers call <code class="function">drm_vblank_get</code>. Upon return vertical
      blanking interrupts are guaranteed to be enabled.
    </p><p>
      To decrement the use count drivers call
      <code class="function">drm_vblank_put</code>. Only when the use count drops to zero
      will the DRM core disable the vertical blanking interrupts after a delay
      by scheduling a timer. The delay is accessible through the vblankoffdelay
      module parameter or the <code class="varname">drm_vblank_offdelay</code> global
      variable and expressed in milliseconds. Its default value is 5000 ms.
      Zero means never disable, and a negative value means disable immediately.
      Drivers may override the behaviour by setting the
      <span class="structname">drm_device</span>
      <em class="structfield"><code>vblank_disable_immediate</code></em> flag, which when set
      causes vblank interrupts to be disabled immediately regardless of the
      drm_vblank_offdelay value. The flag should only be set if there's a
      properly working hardware vblank counter present.
    </p><p>
      When a vertical blanking interrupt occurs drivers only need to call the
      <code class="function">drm_handle_vblank</code> function to account for the
      interrupt.
    </p><p>
      Resources allocated by <code class="function">drm_vblank_init</code> must be freed
      with a call to <code class="function">drm_vblank_cleanup</code> in the driver
      <code class="methodname">unload</code> operation handler.
    </p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm14950"></a>Vertical Blanking and Interrupt Handling Functions Reference</h3></div></div></div><div class="toc"><dl class="toc"><dt><span class="refentrytitle"><a href="API-drm-vblank-cleanup.html"><span class="phrase">drm_vblank_cleanup</span></a></span><span class="refpurpose"> — 
  cleanup vblank support
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-init.html"><span class="phrase">drm_vblank_init</span></a></span><span class="refpurpose"> — 
     initialize vblank support
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-irq-install.html"><span class="phrase">drm_irq_install</span></a></span><span class="refpurpose"> — 
     install IRQ handler
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-irq-uninstall.html"><span class="phrase">drm_irq_uninstall</span></a></span><span class="refpurpose"> — 
     uninstall the IRQ handler
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-calc-timestamping-constants.html"><span class="phrase">drm_calc_timestamping_constants</span></a></span><span class="refpurpose"> — 
     calculate vblank timestamp constants
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-calc-vbltimestamp-from-scanoutpos.html"><span class="phrase">drm_calc_vbltimestamp_from_scanoutpos</span></a></span><span class="refpurpose"> — 
     precise vblank timestamp helper
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-count.html"><span class="phrase">drm_vblank_count</span></a></span><span class="refpurpose"> — 
     retrieve <span class="quote">“<span class="quote">cooked</span>”</span> vblank counter value
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-count-and-time.html"><span class="phrase">drm_vblank_count_and_time</span></a></span><span class="refpurpose"> — 
     retrieve <span class="quote">“<span class="quote">cooked</span>”</span> vblank counter value and the system timestamp corresponding to that vblank counter value.
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-send-vblank-event.html"><span class="phrase">drm_send_vblank_event</span></a></span><span class="refpurpose"> — 
     helper to send vblank event after pageflip
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-get.html"><span class="phrase">drm_vblank_get</span></a></span><span class="refpurpose"> — 
     get a reference count on vblank events
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-crtc-vblank-get.html"><span class="phrase">drm_crtc_vblank_get</span></a></span><span class="refpurpose"> — 
     get a reference count on vblank events
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-put.html"><span class="phrase">drm_vblank_put</span></a></span><span class="refpurpose"> — 
     give up ownership of vblank events
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-crtc-vblank-put.html"><span class="phrase">drm_crtc_vblank_put</span></a></span><span class="refpurpose"> — 
     give up ownership of vblank events
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-wait-one-vblank.html"><span class="phrase">drm_wait_one_vblank</span></a></span><span class="refpurpose"> — 
     wait for one vblank
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-crtc-wait-one-vblank.html"><span class="phrase">drm_crtc_wait_one_vblank</span></a></span><span class="refpurpose"> — 
     wait for one vblank
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-off.html"><span class="phrase">drm_vblank_off</span></a></span><span class="refpurpose"> — 
     disable vblank events on a CRTC
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-crtc-vblank-off.html"><span class="phrase">drm_crtc_vblank_off</span></a></span><span class="refpurpose"> — 
     disable vblank events on a CRTC
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-on.html"><span class="phrase">drm_vblank_on</span></a></span><span class="refpurpose"> — 
     enable vblank events on a CRTC
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-crtc-vblank-on.html"><span class="phrase">drm_crtc_vblank_on</span></a></span><span class="refpurpose"> — 
     enable vblank events on a CRTC
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-pre-modeset.html"><span class="phrase">drm_vblank_pre_modeset</span></a></span><span class="refpurpose"> — 
     account for vblanks across mode sets
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-vblank-post-modeset.html"><span class="phrase">drm_vblank_post_modeset</span></a></span><span class="refpurpose"> — 
     undo drm_vblank_pre_modeset changes
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-handle-vblank.html"><span class="phrase">drm_handle_vblank</span></a></span><span class="refpurpose"> — 
     handle a vblank event
 </span></dt><dt><span class="refentrytitle"><a href="API-drm-crtc-vblank-waitqueue.html"><span class="phrase">drm_crtc_vblank_waitqueue</span></a></span><span class="refpurpose"> — 
  get vblank waitqueue for the CRTC
 </span></dt></dl></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="drm-kms-properties.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="drmInternals.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="API-drm-vblank-cleanup.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">KMS Properties </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> <span class="phrase">drm_vblank_cleanup</span></td></tr></table></div></body></html>
